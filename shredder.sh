#!/bin/bash

# Стандарт: ГОСТ Р 50739-95 / ГОСТ П 50739-2016
# Требования к уничтожению данных:
# - Многократная перезапись случайными данными (не менее 3 проходов).
# - Финальная запись нулей для гарантированного уничтожения данных.
# Этот скрипт реализует методы очистки, соответствующие данным требованиям.

# Функция для вывода предупреждения
show_warning() {
    echo "====================================================================="
    echo "                       ОЧИСТКА ДИСКОВ ПО ГОСТ"
    echo "====================================================================="
    echo "ВНИМАНИЕ: Этот скрипт полностью уничтожит данные на всех дисках."
    echo "Соответствует требованиям ГОСТ Р 50739-95 / ГОСТ П 50739-2016."
    echo "Убедитесь, что вы сохранили все важные данные и работаете в изолированной среде."
    read -p "Продолжить? (y/n): " confirm
    if [[ "$confirm" != "y" ]]; then
        echo "Операция отменена."
        exit 1
    fi
}

# Функция для обнаружения дисков
detect_disks() {
    echo "Обнаружение доступных дисков..."
    disks=$(lsblk -dno name | grep -E '^sd|^nvme|^vd')
    if [[ -z "$disks" ]]; then
        echo "Диски не найдены."
        exit 1
    fi
    echo "Найденные диски:"
    for disk in $disks; do
        echo "- /dev/$disk"
    done
}

# Функция для выбора метода очистки
choose_method() {
    echo "Выберите метод очистки данных (соответствует ГОСТ):"
    echo "1. dd (запись нулей) — БЫСТРЫЙ МЕТОД (НЕ СООТВЕТСТВУЕТ ГОСТ)."
    echo "2. shred (многократная перезапись) — СООТВЕТСТВУЕТ ГОСТ."
    read -p "Введите номер метода (1/2): " method
    if [[ "$method" != "1" && "$method" != "2" ]]; then
        echo "Неверный выбор. Операция отменена."
        exit 1
    fi
}

# Функция для очистки дисков
clean_disks() {
    for disk in $disks; do
        echo "Очистка диска /dev/$disk..."
        if [[ "$method" == "1" ]]; then
            echo "ПРЕДУПРЕЖДЕНИЕ: Метод 'dd' НЕ СООТВЕТСТВУЕТ ГОСТ."
            sudo dd if=/dev/zero of=/dev/$disk bs=1M status=progress
        elif [[ "$method" == "2" ]]; then
            echo "Метод 'shred' соответствует ГОСТ (3 прохода + финальная запись нулей)."
            sudo shred -vzn 3 /dev/$disk
        fi
        echo "Диск /dev/$disk очищен."
    done
}

# Основной блок скрипта
show_warning
detect_disks
choose_method
clean_disks

echo "====================================================================="
echo "                     ОЧИСТКА ЗАВЕРШЕНА ПО ГОСТ"
echo "====================================================================="
